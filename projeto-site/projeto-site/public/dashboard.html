<!doctype html>
<html>

<head>
    <title>Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
    <script src="http://www.chartjs.org/samples/latest/utils.js"></script>
    <script   src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script type="text/javascript" src="funcoes.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
    </style>
    <link rel="stylesheet" href="stylesheets/style-2.css">
    <link rel="icon" href="logo.png" type="image/png">
</head>

<body>

    <header class="header-dash">
        <div id="openNav" class="openbtn" onclick="openNav()">☰ Open Sidebar </div>
        <div id="closeNav" class="closeNav" onclick="closeNav()">☰ Close Sidebar</div>
        <div class="logo-dash"> <img src="logo.png">
            <h2>EVA</h2>
        </div>
    </header>

    <div class="container-forte">
        <section id="sideBar" class="profile-menu">
            <div class="logo"> <img src="logo.png">
                <h2>EVA</h2>
            </div>
            <ul>
                <li><a href="">Perfil</a></li>
                <li><a href="">Configurações</a></li>
                <li><a href="index.html">Sair</a></li>
            </ul>
        </section>

        <div class="container-dash">
            <b id="b_usuario"></b>
            <div class="dash-cima">
                <div class="dash">

                     <div class="dash-boxes">

                        <h3>Última leitura:</h3>
                        <div style="width: 60%;" class="gradiente">
                            <div id="div_posicao" style="margin-left:0%; font-size: 20pt;">
                                <b id="b_leitura">0</b>
                            </div>
                        </div>

                        

                    </div>

                    <div class="dash-boxes">
                        <span>
                        <div style="display: none;">
                            <h1>Sensor LM35 - Temperatura</h1>
                                <section>
                                    <h2>Média: <label id='average'>0.00</label></h2>
                                    <h2>Média Hora: <label id='averageHour'>0.00</label></h2>
                                </section>
                                <section style="width:50%">
                                    <canvas id="chart"></canvas>
                            <section>
                        </div>
                        <div style="display: none;">
                            <section>
                                <h1>Sensor DHT11 - Umidade</h1>
                                <h2>Média: <label id='averageHumidity'>0.00</label></h2>
                                <h2>Média Hora: <label id='averageHourHumidity'>0.00</label></h2>
                            </section>
                            <section style="width:50%">
                                <canvas id="chart-humidity"></canvas>
                            <section>
                        </div>
                        <div style="display: none;">
                            <section>
                                <h1>Sensor TRC5000 - Switch</h1>
                            </section>
                            <section style="width:50%">
                                <canvas id="chart-switch"></canvas>
                            <section>
                        </div>
                    </span>
                        <div >
                            <section>
                                <h1>Sensor LDR - Luminosidade</h1>
                                <h2>Média: <label id='averageLumi'>0.00</label></h2>
                                <h2>Média Hora: <label id='averageHourLumi'>0.00</label></h2>
                            </section>
                            <section style="width:50%">
                                <canvas id="chart-lumi"></canvas>
                            <section>
                        </div>
                    </div> 

                </div>

                <div class="g-pizza-setor dash">
                    <div style="width:100%;">
                        <div id="div_aguarde">Dados sendo obtidos...</div>
                        <canvas id="canvas_grafico"></canvas>
                    </div>
                </div>
            </div>

            <div class="dash-baixo">
                <div class="g-grafico-mensal dash"></div>
            </div>

        </div>
    </div>

</body>

</html>
<!-- side bar -->
<script>
    document.getElementById("sideBar").style.width = "0px"
    document.getElementById("sideBar").style.padding = "0"
    document.getElementById("closeNav").style.display = "none"
    function openNav() {
        document.getElementById("sideBar").style.width = "250px"
        document.getElementById("sideBar").style.padding = "25px"

        document.getElementById("openNav").style.display = "none"
        document.getElementById("closeNav").style.display = "block"
    }
    function closeNav() {
        document.getElementById("sideBar").style.width = "0px"
        document.getElementById("sideBar").style.padding = "0px"

        document.getElementById("openNav").style.display = "block"
        document.getElementById("closeNav").style.display = "none"
    }
</script>

<!-- ng desk -->
<script>
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://eva.ngdesk.com/widgets/chat/5ed019dcee77fa00070ae34e/chat_widget.js";
    document.getElementsByTagName("head")[0].appendChild(script);
</script>

<!-- marise -->
<script>
    var context = document.getElementById("chart").getContext("2d");
    context.canvas.width = 1000;
    context.canvas.height = 300;
    
    var configuration = {
        type: 'line',
        data: {
            datasets: [{
                label: "Temperature x Time",
                type: 'line',
                borderColor: ['#ff3232'],
                backgroundColor: ['#ff7f7f']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    //type: 'value',
                    distribution: 'series',
                    ticks: {
                        beginAtZero:true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Temperature'
                    },
                    ticks: {
                        beginAtZero:true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };
    
    var chart = new Chart(context, configuration);

    //Função para obter os dados de temperatura do server
           
    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexTemp = 0;
    this.time = 0;

    function get_data(){
        
        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:5000/api/luminosity', false);
        http.send(null);        
        
        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0){
            return;
        }
        console.log(obj)
        
        var _lastIndexTemp = this.lastIndexTemp;
        this.lastIndexTemp = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);
        console.log(listTemp)
        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chart.data.labels.length == 10 && chart.data.datasets[0].data.length == 10){
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.data.labels.push(this.time++);
            chart.data.datasets[0].data.push(parseFloat(data));
            chart.update();
        });
        
        document.getElementById('average').textContent = obj.average;
        document.getElementById('averageHour').textContent = obj.averageHour;
    } 

    //Second Graphic

    var context2 = document.getElementById("chart-humidity").getContext("2d");
    context2.canvas.width = 1000;
    context2.canvas.height = 300;
    
    var humidity = {
        type: 'line',
        data: {
            datasets: [{
                label: "Humidity x Time",
                type: 'line',
                borderColor: ['#3232ff'],
                backgroundColor: ['#9999ff']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    //type: 'value',
                    distribution: 'series',
                    ticks: {
                        beginAtZero:true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Humidity'
                    },
                    ticks: {
                        beginAtZero:true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };
    
    var chartHumidity = new Chart(context2, humidity);

    //Função para obter os dados de temperatura do server
    
    
    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexTempHumidity = 0;
    this.timeHumidity = 0;

    function get_dataHumidity(){

        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:5000/api/humidity', false);
        http.send(null);        
        
        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0){
            return;
        }

        var _lastIndexTemp = this.lastIndexTempHumidity;
        this.lastIndexTempHumidity = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);

        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chartHumidity.data.labels.length == 10 && chartHumidity.data.datasets[0].data.length == 10){
                chartHumidity.data.labels.shift();
                chartHumidity.data.datasets[0].data.shift();
            }

            chartHumidity.data.labels.push(this.time++);
            chartHumidity.data.datasets[0].data.push(parseFloat(data));
            chartHumidity.update();
        });
        
        document.getElementById('averageHumidity').textContent = obj.average;
        document.getElementById('averageHourHumidity').textContent = obj.averageHour;
    } 
    
    get_dataHumidity();

    //Thirty Graphic

    var context3 = document.getElementById("chart-switch").getContext("2d");
    context3.canvas.width = 1000;
    context3.canvas.height = 300;
    
    var switch_sensor = {
        type: 'line',
        data: {
            datasets: [{
                label: "Switch x Time",
                type: 'line',
                borderColor: ['#ae3f3f'],
                backgroundColor: ['#c97f7f']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    //type: 'value',
                    distribution: 'series',
                    ticks: {
                        beginAtZero:true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Switch'
                    },
                    ticks: {
                        beginAtZero:true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };
    
    var chartSwitch = new Chart(context3, switch_sensor);

    //Função para obter os dados de temperatura do server
            
    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexTempHumidity = 0;
    this.timeSwitch = 0;

    function get_switch(){

        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:5000/api/switch', false);
        http.send(null);        
        
        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0){
            return;
        }

        var _lastIndexTemp = this.lastIndexTempSwitch;
        this.lastIndexTempSwitch = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);

        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chartSwitch.data.labels.length == 10 && chartSwitch.data.datasets[0].data.length == 10){
                chartSwitch.data.labels.shift();
                chartSwitch.data.datasets[0].data.shift();
            }

            chartSwitch.data.labels.push(this.time++);
            chartSwitch.data.datasets[0].data.push(parseFloat(data));
            chartSwitch.update();
        });
        
    } 
    
    get_switch();

    //Fourty Graphic

    var context4 = document.getElementById("chart-lumi").getContext("2d");
    context4.canvas.width = 1000;
    context4.canvas.height = 300;
    
    var lumi_sensor = {
        type: 'line',
        data: {
            datasets: [{
                label: "Luminosity x Time",
                type: 'line',
                borderColor: ['#ffff19'],
                backgroundColor: ['#ffff7f']
            }]
        },
        options: {
            scales: {
                xAxes: [{
                    //type: 'value',
                    distribution: 'series',
                    ticks: {
                        beginAtZero:true
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Luminosity'
                    },
                    ticks: {
                        beginAtZero:true
                    }
                }]
            },
            animation: {
                duration: 0
            }
        }
    };
    
    var chartLumi = new Chart(context4, lumi_sensor);

    //Função para obter os dados de temperatura do server
            
    //Esse atributo dentro do contexto serve para saber qual foi o último índice processado, assim eliminado os outros elementos na
    //hora de montar/atualizar o gráfico
    this.lastIndexLumi = 0;
    this.timeLumi = 0;

    function get_lumi(){
        console.warn('AAAAAAAAAA')
        var http = new XMLHttpRequest();
        http.open('GET', 'http://localhost:5000/api/luminosity', false);
        http.send(null);        
        
        var obj = JSON.parse(http.responseText);
        if (obj.data.length == 0){
            return;
        }
        console.log(obj)

        var _lastIndexTemp = this.lastIndexLumi;
        this.lastIndexLumi = obj.data.length;
        listTemp = obj.data.slice(_lastIndexTemp);

        listTemp.forEach(data => {
            //Máximo de 60 itens exibidos no gráfico
            if (chartLumi.data.labels.length == 10 && chartLumi.data.datasets[0].data.length == 10){
                chartLumi.data.labels.shift();
                chartLumi.data.datasets[0].data.shift();
            }

            chartLumi.data.labels.push(this.time++);
            chartLumi.data.datasets[0].data.push(parseFloat(data));
            chartLumi.update();
        });

        document.getElementById('averageLumi').textContent = obj.average;
        document.getElementById('averageHourLumi').textContent = obj.averageHour;
        
    } 
    
    get_lumi();

    function sendTemperature(){
        var http = new XMLHttpRequest();
        http.open('POST', 'http://localhost:3000/api/sendData', false);
        http.send(null);
    }




    setInterval(() => {
        get_data();
        get_dataHumidity();
        get_switch();
        get_lumi();
        sendTemperature();
    }, 3000);
    

</script>

<!-- yoshi -->
<script>

    window.onload = obterDadosGrafico;

    verificar_autenticacao();

    // neste JSON tem que ser 'labels', 'datasets' etc, 
    // porque é o padrão do Chart.js
    var dados = {
        labels: [],
        datasets: [
            {
                yAxisID: 'y-luminosidade',
                label: 'Luminosidade',
                borderColor: window.chartColors.red,
                backgroundColor: window.chartColors.red,
                fill: false,
                data: []
            }
            
        ]
    };


    // só mexer se quiser alterar o tempo de atualização
    // ou se souber o que está fazendo!
    function atualizarGrafico() {

        fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    
                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro.momento_grafico); // incluir um novo momento
                    dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[0].data.push(novoRegistro.luminosidade); // incluir uma nova leitura de temperatura
                    window.grafico_linha.update();
                    
                    setTimeout(atualizarGrafico, 5000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                setTimeout(atualizarGrafico, 5000);
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
        
    }

    // altere aqui as configurações do gráfico
    // (tamanhos, cores, textos, etc)
    function configurarGrafico() {
        var configuracoes = {
            responsive: true,
            animation: {duration: 500},
            hoverMode: 'index',
            stacked: false,
            title: {
                display: true,
                text: 'Histórico recente de Luminosidade'
            },
            scales: {
                yAxes: [{
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'left',
                    id: 'y-luminosidade',
                }],
            }
        };

        return configuracoes;
    }

    // altere aqui como os dados serão exibidos
    // e como são recuperados do BackEnd
    function obterDadosGrafico() {

        fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    // console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    resposta.reverse();

                    for (i = 0; i < resposta.length; i++) {
                        var registro = resposta[i];
                    
                        // aqui, após 'registro.' use os nomes 
                        // dos atributos que vem no JSON 
                        // que gerou na consulta ao banco de dados

                        dados.labels.push(registro.momento_grafico);

                        dados.datasets[0].data.push(registro.luminosidade);
                    }
                    // console.log(JSON.stringify(dados));

                    div_aguarde.style.display = 'none';

                    plotarGrafico(dados);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });

    }

    // só altere aqui se souber o que está fazendo!
    function plotarGrafico(dados) {
        // console.log('iniciando plotagem do gráfico...');

        var ctx = canvas_grafico.getContext('2d');
        window.grafico_linha = Chart.Line(ctx, {
            data: dados,
            options: configurarGrafico()
        });

        setTimeout(atualizarGrafico, 5000);
    }

</script>